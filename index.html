<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Emotionstagebuch – App</title>

  <!-- PWA -->
  <meta name="theme-color" content="#008B8B"/>
  <link rel="manifest" href="/manifest.webmanifest">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Emotionstagebuch">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Webfonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@600&family=Heebo:wght@300;400;500;700&display=swap" rel="stylesheet">

  <!-- PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    /* --- Robustes Print-Stylesheet für PDF/Druck --- */
    @media print {
      body, html {
        background: #fff !important;
        color: #222 !important;
        font-family: 'Heebo', Arial, sans-serif !important;
      }
      h1, h2, h3, h4, .heading, .toskana-green, .toskana-green-bg {
        color: #222 !important;
        background: none !important;
        font-family: 'Caveat', cursive !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
      /* Nur Steuerelemente ausblenden */
      button, input, select, textarea, .success-message, #btnInstall, #btnPDF, #btnPrint, #btnToggleAll, [onclick*="clearAllData"] {
        display: none !important;
      }
      /* Seitenränder für A4 */
      @page { size: A4; margin: 16mm; }
    }
    :root { color-scheme: light; }
    body { font-family: 'Heebo', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: linear-gradient(135deg, #f0f8f8 0%, #e0f2f2 100%); }
    h1, h2, h3, h4, .heading { font-family: 'Caveat', cursive; }
    .toskana-green { color: #008B8B; }
    .toskana-green-bg { background-color: #008B8B; }
    .gradient-header { background: linear-gradient(135deg, #008B8B 0%, #20B2AA 50%, #48D1CC 100%); }
    @page { size: A4; margin: 16mm; }
    .emotion-chip { display:inline-block; background:#008B8B; color:white; padding:4px 12px; border-radius:20px; margin:2px; font-size:14px; }
    .entry-card { border-left:4px solid #008B8B; background:white; padding:20px; margin-bottom:16px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
    .success-message { position:fixed; top:20px; right:20px; background:#10B981; color:white; padding:12px 20px; border-radius:8px; z-index:1000; animation: slideIn .3s ease-out; }
    @keyframes slideIn { from{ transform:translateX(100%); opacity:0; } to{ transform:translateX(0); opacity:1; } }
    .card{ page-break-inside: avoid; break-inside: avoid; }
  </style>
</head>
<body class="min-h-screen p-5">
  <div class="max-w-6xl mx-auto">
    <!-- INSTALL & INFO (App ONLY) -->
    <div class="bg-white rounded-lg shadow mb-4 p-4 flex items-start gap-3">
      <img src="/icons/icon-192.png" alt="App-Icon" class="w-12 h-12 rounded-lg"/>
      <div class="text-sm leading-relaxed">
        <div class="font-semibold text-gray-800 flex items-center gap-2"><span class="text-xl">😊</span> Emotionstagebuch – App</div>
        <ul class="list-disc ml-5 mt-1">
          <li><span class="font-medium">Installation iPhone/iPad:</span> In Safari „Teilen“ → <em>Zum Home-Bildschirm</em>. Danach startet die App im Vollbild & funktioniert offline.</li>
          <li><span class="font-medium">Installation Android:</span> In Chrome oben rechts „App installieren“ oder unten auf <button id="btnInstall" hidden class="px-2 py-1 bg-emerald-600 text-white rounded">Installieren</button> tippen.</li>
          <li><span class="font-medium">Speichern & Löschen:</span> Deine Einträge bleiben lokal auf diesem Gerät. In der Liste unten kannst du einzelne Einträge löschen oder alle entfernen.</li>
          <li><span class="font-medium">Teilen/Drucken:</span> Über die Buttons „Drucken“ (Auswahl/Alle).</li>
        </ul>
      </div>
    </div>

    <!-- HEADER -->
    <div class="gradient-header text-white p-8 rounded-lg text-center mb-6">
      <div class="text-5xl mb-2">🧭</div>
      <h1 class="heading text-3xl mb-1">Interaktiver Emotionstracker</h1>
      <p class="text-base opacity-90">Kostenfrei, ohne Registrierung. Offline nutzbar – als App auf deinem Gerät. Dieses Tool ersetzt keine Therapie. Wende dich bei großen Sorgen an Vertrauenspersonen oder Fachleute.</p>
    </div>

    <!-- FORM -->
    <div class="bg-white rounded-lg shadow p-6 mb-8">
      <h2 class="heading text-2xl mb-4 toskana-green">✏️ Neuer Eintrag</h2>
      <form id="moodForm" class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm mb-2">📅 Datum & Zeit</label>
            <input type="datetime-local" id="dateTime" class="w-full p-3 border-2 border-gray-200 rounded-lg"/>
          </div>
          <div>
            <label class="block text-sm mb-2">🌈 Gesamtstimmung (0–10)</label>
            <input type="range" id="mood" min="0" max="10" value="5" class="w-full"/>
            <div class="flex justify-between text-xs text-gray-500 mt-1">
              <span>0</span><span id="moodValue" class="font-bold text-lg toskana-green">5</span><span>10</span>
            </div>
          </div>
        </div>

        <section>
          <h3 class="heading text-xl toskana-green mb-2">💟 Emotionen heute (0–10)</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
            <div>
              <label class="block text-sm mb-2">Emotion auswählen</label>
              <select id="emotionSelect" class="w-full p-3 border-2 border-gray-200 rounded-lg">
                <option value="">-- Emotion wählen --</option>
                <option value="Freude">😊 Freude</option>
                <option value="Trauer">😢 Trauer</option>
                <option value="Wut">😠 Wut</option>
                <option value="Angst">😰 Angst</option>
                <option value="Überraschung">😲 Überraschung</option>
                <option value="Ekel">🤢 Ekel</option>
                <option value="Verachtung">😤 Verachtung</option>
                <option value="Stolz">😌 Stolz</option>
                <option value="Scham">😳 Scham</option>
                <option value="Schuld">😔 Schuld</option>
                <option value="Neid">😒 Neid</option>
                <option value="Eifersucht">😡 Eifersucht</option>
                <option value="Hoffnung">🤗 Hoffnung</option>
                <option value="Enttäuschung">😞 Enttäuschung</option>
                <option value="Erleichterung">😌 Erleichterung</option>
                <option value="Dankbarkeit">🙏 Dankbarkeit</option>
                <option value="Liebe">❤️ Liebe</option>
                <option value="Hass">💢 Hass</option>
                <option value="Verwirrung">😕 Verwirrung</option>
                <option value="Langeweile">😑 Langeweile</option>
              </select>
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm mb-2">Stärke</label>
              <input type="range" id="emotionSlider" min="0" max="10" value="0" class="w-full" disabled/>
              <div class="flex justify-between text-xs text-gray-500 mt-1">
                <span>0</span><span id="emotionSliderValue" class="font-bold toskana-green">0</span><span>10</span>
              </div>
              <p class="text-[12px] text-gray-500 mt-1">Emotion wählen → Regler schieben → nächstes Gefühl wählen.</p>
            </div>
          </div>
          <div class="mt-3">
            <div id="emotionChips" class="min-h-[40px] p-3 bg-gray-50 rounded-lg border-2 border-dashed border-gray-200">
              <p class="text-sm text-gray-500">Deine gewählten Emotionen erscheinen hier…</p>
            </div>
          </div>
        </section>

        <section>
          <h3 class="heading text-xl toskana-green mb-2">🎯 Aktivitäten heute</h3>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
            <label class="flex items-center gap-2"><input type="checkbox" name="activities" value="Sport" class="rounded"/>🏃‍♂️ Sport</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="activities" value="Arbeit" class="rounded"/>💼 Arbeit</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="activities" value="Familie" class="rounded"/>👨‍👩‍👧‍👦 Familie</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="activities" value="Freunde" class="rounded"/>👥 Freunde</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="activities" value="Hobbys" class="rounded"/>🎨 Hobbys</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="activities" value="Entspannung" class="rounded"/>🧘‍♀️ Entspannung</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="activities" value="Lernen" class="rounded"/>📚 Lernen</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="activities" value="Natur" class="rounded"/>🌳 Natur</label>
          </div>
        </section>

        <section>
          <h3 class="heading text-xl toskana-green mb-2">🎓 Schule & Bildung</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm mb-2">📚 Schulstress (0–10)</label>
              <input type="range" id="schoolStress" min="0" max="10" value="0" class="w-full"/>
              <div class="flex justify-between text-xs text-gray-500 mt-1"><span>0</span><span id="schoolStressValue" class="font-bold toskana-green">0</span><span>10</span></div>
            </div>
            <div>
              <label class="block text-sm mb-2">✏️ Hausaufgaben erledigt</label>
              <select id="homework" class="w-full p-3 border-2 border-gray-200 rounded-lg">
                <option value="">-- Auswählen --</option>
                <option value="Alle erledigt">✅ Alle erledigt</option>
                <option value="Teilweise erledigt">⚠️ Teilweise erledigt</option>
                <option value="Nicht erledigt">❌ Nicht erledigt</option>
                <option value="Keine Hausaufgaben">➖ Keine Hausaufgaben</option>
              </select>
            </div>
          </div>
          <div class="mt-3 grid grid-cols-2 md:grid-cols-3 gap-3">
            <label class="flex items-center gap-2"><input type="checkbox" name="schoolEvents" value="Gute Note" class="rounded"/>📝 Gute Note</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="schoolEvents" value="Schlechte Note" class="rounded"/>📉 Schlechte Note</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="schoolEvents" value="Klassenarbeit" class="rounded"/>📋 Klassenarbeit</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="schoolEvents" value="Präsentation" class="rounded"/>🎤 Präsentation</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="schoolEvents" value="Pausengespräch" class="rounded"/>💬 Pausengespräch</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="schoolEvents" value="Lehrergespräch" class="rounded"/>👨‍🏫 Lehrergespräch</label>
          </div>
        </section>

        <section>
          <h3 class="heading text-xl toskana-green mb-2">🍽️ Essen & Trinken</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div>
              <label class="block text-sm mb-2">🥗 Mahlzeiten heute</label>
              <div class="space-y-2">
                <label class="flex items-center gap-2"><input type="checkbox" name="meals" value="Frühstück" class="rounded"/>🌅 Frühstück</label>
                <label class="flex items-center gap-2"><input type="checkbox" name="meals" value="Mittagessen" class="rounded"/>🌞 Mittagessen</label>
                <label class="flex items-center gap-2"><input type="checkbox" name="meals" value="Abendessen" class="rounded"/>🌙 Abendessen</label>
                <label class="flex items-center gap-2"><input type="checkbox" name="meals" value="Snacks" class="rounded"/>🍪 Snacks</label>
              </div>
            </div>
            <div>
              <label class="block text-sm mb-2">💧 Wasser getrunken (Gläser)</label>
              <input type="range" id="water" min="0" max="15" value="0" class="w-full"/>
              <div class="flex justify-between text-xs text-gray-500 mt-1"><span>0</span><span id="waterValue" class="font-bold toskana-green">0</span><span>15+</span></div>
            </div>
            <div>
              <label class="block text-sm mb-2">🍎 Gesunde Ernährung (0–10)</label>
              <input type="range" id="nutrition" min="0" max="10" value="5" class="w-full"/>
              <div class="flex justify-between text-xs text-gray-500 mt-1"><span>0</span><span id="nutritionValue" class="font-bold toskana-green">5</span><span>10</span></div>
            </div>
          </div>
        </section>

        <section>
          <h3 class="heading text-xl toskana-green mb-2">😔 Mobbing & Soziale Probleme</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm mb-2">🎯 Mobbing erlebt heute</label>
              <select id="bullying" class="w-full p-3 border-2 border-gray-200 rounded-lg">
                <option value="">-- Auswählen --</option>
                <option value="Nein">✅ Nein, alles okay</option>
                <option value="Verbal">🗣️ Verbales Mobbing</option>
                <option value="Körperlich">👊 Körperliches Mobbing</option>
                <option value="Online">💻 Cybermobbing</option>
                <option value="Ausgrenzung">🚫 Ausgrenzung</option>
                <option value="Gerüchte">💬 Gerüchte/Lästereien</option>
              </select>
            </div>
            <div>
              <label class="block text-sm mb-2">😰 Belastung durch soziale Probleme (0–10)</label>
              <input type="range" id="socialStress" min="0" max="10" value="0" class="w-full"/>
              <div class="flex justify-between text-xs text-gray-500 mt-1"><span>0</span><span id="socialStressValue" class="font-bold toskana-green">0</span><span>10</span></div>
            </div>
          </div>
          <div class="mt-3 grid grid-cols-2 md:grid-cols-3 gap-3">
            <label class="flex items-center gap-2"><input type="checkbox" name="socialEvents" value="Neue Freundschaft" class="rounded"/>🤝 Neue Freundschaft</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="socialEvents" value="Streit" class="rounded"/>😠 Streit</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="socialEvents" value="Versöhnung" class="rounded"/>🤗 Versöhnung</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="socialEvents" value="Gruppenarbeit" class="rounded"/>👨‍👩‍👧‍👦 Gruppenarbeit</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="socialEvents" value="Allein gefühlt" class="rounded"/>😞 Allein gefühlt</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="socialEvents" value="Unterstützung erhalten" class="rounded"/>💪 Unterstützung erhalten</label>
          </div>
        </section>

        <section>
          <h3 class="heading text-xl toskana-green mb-2">🛠️ Bewältigungsstrategien</h3>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
            <label class="flex items-center gap-2"><input type="checkbox" name="copingStrategies" value="Tief atmen" class="rounded"/>🫁 Tief atmen</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="copingStrategies" value="Musik hören" class="rounded"/>🎵 Musik hören</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="copingStrategies" value="Sport machen" class="rounded"/>🏃‍♂️ Sport machen</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="copingStrategies" value="Mit Freunden reden" class="rounded"/>💬 Mit Freunden reden</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="copingStrategies" value="Tagebuch schreiben" class="rounded"/>📔 Tagebuch schreiben</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="copingStrategies" value="Meditation" class="rounded"/>🧘‍♀️ Meditation</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="copingStrategies" value="Spazieren gehen" class="rounded"/>🚶‍♂️ Spazieren gehen</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="copingStrategies" value="Kreativ sein" class="rounded"/>🎨 Kreativ sein</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="copingStrategies" value="Hilfe suchen" class="rounded"/>🆘 Hilfe suchen</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="copingStrategies" value="Ablenkung" class="rounded"/>📱 Ablenkung</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="copingStrategies" value="Positive Gedanken" class="rounded"/>💭 Positive Gedanken</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="copingStrategies" value="Nichts gemacht" class="rounded"/>😶 Nichts gemacht</label>
          </div>
        </section>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm mb-2">😴 Schlafqualität (0–10)</label>
            <input type="range" id="sleep" min="0" max="10" value="5" class="w-full"/>
            <div class="flex justify-between text-xs text-gray-500 mt-1"><span>0</span><span id="sleepValue" class="font-bold toskana-green">5</span><span>10</span></div>
          </div>
          <div>
            <label class="block text-sm mb-2">⚡ Energielevel (0–10)</label>
            <input type="range" id="energy" min="0" max="10" value="5" class="w-full"/>
            <div class="flex justify-between text-xs text-gray-500 mt-1"><span>0</span><span id="energyValue" class="font-bold toskana-green">5</span><span>10</span></div>
          </div>
        </div>

        <div>
          <label class="block text-sm mb-2">📝 Notizen & Gedanken</label>
          <textarea id="notes" rows="4" class="w-full p-3 border-2 border-gray-200 rounded-lg resize-none" placeholder="Was beschäftigt dich heute?"></textarea>
        </div>

        <div class="text-center">
          <button type="submit" class="toskana-green-bg text-white px-8 py-3 rounded-lg font-medium hover:bg-opacity-90 transition-colors">💾 Eintrag speichern</button>
        </div>
      </form>
    </div>

    <!-- ANALYSIS -->
    <div class="bg-white rounded-lg shadow p-6 mb-8">
      <h2 class="heading text-2xl mb-4 toskana-green">📈 Auswertung & Trends</h2>
      <div id="analysisSection"><p class="text-gray-500 text-center py-6">Erstelle mindestens 3 Einträge, um eine Auswertung zu sehen!</p></div>
    </div>

    <!-- ENTRIES -->
    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-3">
        <h2 class="heading text-2xl toskana-green">📊 Meine Einträge</h2>
        <div class="w-full mb-2 text-sm text-blue-700 bg-blue-50 rounded p-2">
          <strong>PDF teilen?</strong> Klicke auf <b>Drucken / PDF</b>, dann auf <b>PDF-Vorschau</b> und teile das PDF z.B. per WhatsApp oder E-Mail.
        </div>
        <div class="flex flex-wrap items-center gap-2">
          <span id="selectionInfo" class="text-sm text-gray-700">Auswahl: 0</span>
          <input type="text" id="printName" placeholder="Name (optional)" class="px-3 py-2 border-2 border-gray-200 rounded-lg text-sm" style="width: 180px;">
          <button id="btnToggleAll" class="bg-blue-500 text-white px-3 py-2 rounded-lg text-sm hover:bg-blue-600">☑️ Alle auswählen</button>
          <button id="btnPrint" class="bg-emerald-600 text-white px-3 py-2 rounded-lg text-sm hover:bg-emerald-700">🖨️ Drucken / PDF</button>
          <button onclick="clearAllData()" class="bg-red-500 text-white px-3 py-2 rounded-lg text-sm hover:bg-red-600">🗑️ Alle löschen</button>
        </div>
      </div>
      <div id="entriesList"><p class="text-gray-500 text-center py-6">Noch keine Einträge vorhanden. Erstelle deinen ersten Eintrag oben!</p></div>
      <div class="w-full mt-4 text-sm text-blue-700 bg-blue-50 rounded p-2 text-center">
  <strong>PDF teilen?</strong> Klicke auf <b>Drucken / PDF</b>, dann auf <b>PDF-Vorschau</b> und teile das PDF z.B. per WhatsApp oder E-Mail.
      </div>
      <div class="text-center text-xs text-gray-600 mt-6 mb-2">© Eva Tam – Emotionstagebuch (App). Private Nutzung erlaubt. Kommerzielle Nutzung nur mit schriftlicher Erlaubnis.</div>
    </div>
  </div>

  <script src="/install.js"></script>
  <script>
    function safeGetLocalStorage(key, fallback) { try { return JSON.parse(localStorage.getItem(key)) ?? fallback; } catch(e){ return fallback; } }
    function safeSetLocalStorage(key, value) { try { localStorage.setItem(key, JSON.stringify(value)); return true; } catch(e){ console.warn('localStorage nicht verfügbar:', e); return false; } }

    let currentEmotions = {};
    let entries = safeGetLocalStorage('moodEntries', []);

    document.addEventListener('DOMContentLoaded', function() {
      const now = new Date();
      now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
      document.getElementById('dateTime').value = now.toISOString().slice(0, 16);
      setupEventListeners();
      displayEntries();
      // iOS: Hinweis, wenn nicht im Standalone
      const isIOS = /iPhone|iPad|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
      if (isIOS && !isStandalone) {
        // keep the box already shown
      }
    });

    function setupEventListeners() {
      document.getElementById('mood').addEventListener('input', function() { document.getElementById('moodValue').textContent = this.value; });
      document.getElementById('sleep').addEventListener('input', function() { document.getElementById('sleepValue').textContent = this.value; });
      document.getElementById('energy').addEventListener('input', function() { document.getElementById('energyValue').textContent = this.value; });
      document.getElementById('schoolStress').addEventListener('input', function() { document.getElementById('schoolStressValue').textContent = this.value; });
      document.getElementById('socialStress').addEventListener('input', function() { document.getElementById('socialStressValue').textContent = this.value; });
      document.getElementById('water').addEventListener('input', function() { document.getElementById('waterValue').textContent = this.value; });
      document.getElementById('nutrition').addEventListener('input', function() { document.getElementById('nutritionValue').textContent = this.value; });

      document.getElementById('emotionSelect').addEventListener('change', function() {
        const slider = document.getElementById('emotionSlider');
        if (this.value) {
          slider.disabled = false;
          // Wenn vorher eine andere Emotion gewählt war, Wert übernehmen
          if (slider.value > 0) {
            const prevEmotion = slider.getAttribute('data-prev-emotion');
            if (prevEmotion) {
              currentEmotions[prevEmotion] = parseInt(slider.value);
            }
          }
          slider.value = currentEmotions[this.value] || 0;
          document.getElementById('emotionSliderValue').textContent = slider.value;
          slider.setAttribute('data-prev-emotion', this.value);
        } else {
          slider.disabled = true;
          slider.value = 0;
          document.getElementById('emotionSliderValue').textContent = '0';
          slider.removeAttribute('data-prev-emotion');
        }
        updateEmotionChips();
      });

      document.getElementById('emotionSlider').addEventListener('input', function() {
        const selectedEmotion = document.getElementById('emotionSelect').value;
        document.getElementById('emotionSliderValue').textContent = this.value;
        if (selectedEmotion) {
          if (this.value > 0) { currentEmotions[selectedEmotion] = parseInt(this.value); } else { delete currentEmotions[selectedEmotion]; }
          updateEmotionChips();
        }
      });

      document.getElementById('moodForm').addEventListener('submit', function(e) { e.preventDefault(); saveEntry(); });

      document.getElementById('btnToggleAll').addEventListener('click', toggleAllEntries);
      document.getElementById('btnPrint').addEventListener('click', printSelectedEntries);
    }

    function updateEmotionChips() {
      const container = document.getElementById('emotionChips');
      if (Object.keys(currentEmotions).length === 0) {
        container.innerHTML = '<p class="text-sm text-gray-500">Deine gewählten Emotionen erscheinen hier…</p>';
        return;
      }
      let html = '';
      for (const [emotion, value] of Object.entries(currentEmotions)) {
        html += `<span class="emotion-chip">${emotion}: ${value}/10</span>`;
      }
      container.innerHTML = html;
    }

    function saveEntry() {
      const formData = new FormData(document.getElementById('moodForm'));
      const entry = {
        id: Date.now(),
        dateTime: document.getElementById('dateTime').value,
        mood: parseInt(document.getElementById('mood').value),
        emotions: {...currentEmotions},
        activities: Array.from(formData.getAll('activities')),
        schoolStress: parseInt(document.getElementById('schoolStress').value),
        homework: document.getElementById('homework').value,
        schoolEvents: Array.from(formData.getAll('schoolEvents')),
        meals: Array.from(formData.getAll('meals')),
        water: parseInt(document.getElementById('water').value),
        nutrition: parseInt(document.getElementById('nutrition').value),
        bullying: document.getElementById('bullying').value,
        socialStress: parseInt(document.getElementById('socialStress').value),
        socialEvents: Array.from(formData.getAll('socialEvents')),
        copingStrategies: Array.from(formData.getAll('copingStrategies')),
        sleep: parseInt(document.getElementById('sleep').value),
        energy: parseInt(document.getElementById('energy').value),
        notes: document.getElementById('notes').value.trim()
      };
      entries.unshift(entry);
      safeSetLocalStorage('moodEntries', entries);
      document.getElementById('moodForm').reset();
      currentEmotions = {};
      updateEmotionChips();
      const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
      document.getElementById('dateTime').value = now.toISOString().slice(0, 16);
      ['moodValue','sleepValue','energyValue'].forEach(id => document.getElementById(id).textContent = id==='moodValue'?'5':'5');
      ['schoolStressValue','socialStressValue','waterValue'].forEach(id => document.getElementById(id).textContent = '0');
      document.getElementById('nutritionValue').textContent = '5';
      document.getElementById('emotionSliderValue').textContent = '0';
      document.getElementById('emotionSlider').disabled = true;
      displayEntries();
      showSuccessMessage('Eintrag gespeichert!');
    }

    function displayEntries() {
      const container = document.getElementById('entriesList');
      if (entries.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-6">Noch keine Einträge vorhanden. Erstelle deinen ersten Eintrag oben!</p>';
        updateAnalysis(); updateSelectionInfo(); return;
      }
      let html = '';
      entries.forEach(entry => {
        const date = new Date(entry.dateTime);
        const formattedDate = date.toLocaleDateString('de-DE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });

        let emotionsHtml = Object.keys(entry.emotions||{}).length ? Object.entries(entry.emotions).map(([e,v])=>`<span class="emotion-chip">${e}: ${v}/10</span>`).join('') : '<span class="text-gray-500 text-sm">Keine Emotionen erfasst</span>';
        let activitiesHtml = entry.activities?.length ? entry.activities.map(a=>`<span class="bg-gray-200 px-2 py-1 rounded text-sm">${a}</span>`).join(' ') : '<span class="text-gray-500 text-sm">Keine Aktivitäten erfasst</span>';
        let schoolEventsHtml = entry.schoolEvents?.length ? entry.schoolEvents.map(e=>`<span class="bg-blue-200 px-2 py-1 rounded text-sm">${e}</span>`).join(' ') : '<span class="text-gray-500 text-sm">Keine Schulerlebnisse</span>';
        let mealsHtml = entry.meals?.length ? entry.meals.map(m=>`<span class="bg-green-200 px-2 py-1 rounded text-sm">${m}</span>`).join(' ') : '<span class="text-gray-500 text-sm">Keine Mahlzeiten</span>';
        let socialEventsHtml = entry.socialEvents?.length ? entry.socialEvents.map(s=>`<span class="bg-purple-200 px-2 py-1 rounded text-sm">${s}</span>`).join(' ') : '<span class="text-gray-500 text-sm">Keine sozialen Ereignisse</span>';
        let copingHtml = entry.copingStrategies?.length ? entry.copingStrategies.map(c=>`<span class="bg-yellow-200 px-2 py-1 rounded text-sm">${c}</span>`).join(' ') : '<span class="text-gray-500 text-sm">Keine Strategien</span>';

        let basicInfo = `🌈 Stimmung: ${entry.mood}/10 | 😴 Schlaf: ${entry.sleep}/10 | ⚡ Energie: ${entry.energy}/10`;
        let stressParts = [];
        if ((entry.schoolStress||0) > 0) stressParts.push(`📚 Schulstress: ${entry.schoolStress}/10`);
        if ((entry.socialStress||0) > 0) stressParts.push(`😰 Sozialer Stress: ${entry.socialStress}/10`);
        if (stressParts.length) basicInfo += ' | ' + stressParts.join(' | ');

        let special = [];
        if (entry.homework) special.push(`✏️ Hausaufgaben: ${entry.homework}`);
        if (entry.bullying && entry.bullying !== 'Nein') special.push(`🎯 Mobbing: ${entry.bullying}`);
        if ((entry.water||0) > 5) special.push(`💧 Wasser: ${entry.water} Gläser`);
        if ((entry.nutrition||5) < 4 || (entry.nutrition||5) > 7) special.push(`🍎 Ernährung: ${entry.nutrition}/10`);

        let relevantSections = [];
        if (Object.keys(entry.emotions||{}).length) relevantSections.push(`<div class="mb-2"><strong>💟 Emotionen:</strong> ${emotionsHtml}</div>`);
        if (entry.activities?.length) relevantSections.push(`<div class="mb-2"><strong>🎯 Aktivitäten:</strong> ${activitiesHtml}</div>`);
        if (entry.schoolEvents?.length) relevantSections.push(`<div class="mb-2"><strong>🏫 Schulerlebnisse:</strong> ${schoolEventsHtml}</div>`);
        if (entry.meals?.length) relevantSections.push(`<div class="mb-2"><strong>🥗 Mahlzeiten:</strong> ${mealsHtml}</div>`);
        if (entry.socialEvents?.length) relevantSections.push(`<div class="mb-2"><strong>👥 Soziale Ereignisse:</strong> ${socialEventsHtml}</div>`);
        if (entry.copingStrategies?.length) relevantSections.push(`<div class="mb-2"><strong>🛠️ Bewältigungsstrategien:</strong> ${copingHtml}</div>`);
        if (entry.notes && entry.notes.trim()) relevantSections.push(`<div class="mb-2"><strong>📝 Notizen:</strong> ${entry.notes}</div>`);
        if (special.length) relevantSections.push(`<div class="mb-2"><strong>📋 Besonderes:</strong> ${special.join(' | ')}</div>`);

        html += `
          <div class="entry-card">
            <div class="flex justify-between items-start mb-3">
              <div class="flex items-center gap-3">
                <input type="checkbox" class="entry-checkbox" data-entry-id="${entry.id}"/>
                <div>
                  <h3 class="heading text-xl toskana-green">${formattedDate}</h3>
                  <div class="text-lg font-bold toskana-green mb-1">${basicInfo}</div>
                </div>
              </div>
              <button onclick="deleteEntry(${entry.id})" class="text-red-500 hover:text-red-700 text-sm">🗑️ Löschen</button>
            </div>
            ${relevantSections.join('')}
          </div>
        `;
      });
      container.innerHTML = html;
      updateAnalysis();
      updateSelectionInfo();
    }

    function updateAnalysis() {
      const analysisContainer = document.getElementById('analysisSection');
      if (entries.length < 3) { analysisContainer.innerHTML = '<p class="text-gray-500 text-center py-6">Erstelle mindestens 3 Einträge, um eine Auswertung zu sehen!</p>'; return; }
      const avgMood = (entries.reduce((s, e) => s + e.mood, 0) / entries.length).toFixed(1);
      const avgSleep = (entries.reduce((s, e) => s + e.sleep, 0) / entries.length).toFixed(1);
      const avgEnergy = (entries.reduce((s, e) => s + e.energy, 0) / entries.length).toFixed(1);
      const schoolStressEntries = entries.filter(e => (e.schoolStress || 0) > 0);
      const avgSchoolStress = schoolStressEntries.length ? (schoolStressEntries.reduce((s, e) => s + (e.schoolStress || 0), 0) / schoolStressEntries.length).toFixed(1) : null;
      const socialStressEntries = entries.filter(e => (e.socialStress || 0) > 0);
      const avgSocialStress = socialStressEntries.length ? (socialStressEntries.reduce((s, e) => s + (e.socialStress || 0), 0) / socialStressEntries.length).toFixed(1) : null;

      const emotionCounts = {};
      entries.forEach(e => { if (e.emotions) Object.keys(e.emotions).forEach(em => emotionCounts[em] = (emotionCounts[em] || 0) + 1); });
      const hasEmotions = Object.keys(emotionCounts).length > 0;
      const topEmotions = hasEmotions ? Object.entries(emotionCounts).sort(([,a],[,b]) => b - a).slice(0,3).map(([em,c]) => `${em} (${c}x)`).join(', ') : null;

      const copingCounts = {};
      entries.forEach(e => (e.copingStrategies || []).forEach(c => copingCounts[c] = (copingCounts[c] || 0) + 1));
      const hasCoping = Object.keys(copingCounts).length > 0;
      const topCoping = hasCoping ? Object.entries(copingCounts).sort(([,a],[,b]) => b - a).slice(0,3).map(([c,n]) => `${c} (${n}x)`).join(', ') : null;

      const bullyingEntries = entries.filter(e => e.bullying && e.bullying !== 'Nein' && e.bullying !== '');
      const hasBullying = bullyingEntries.length > 0;
      const bullyingPercentage = hasBullying ? ((bullyingEntries.length / entries.length) * 100).toFixed(1) : null;

      let cardsHtml = `
        <div class="bg-blue-50 p-4 rounded-lg">
          <h4 class="heading text-lg toskana-green mb-2">📊 Durchschnittswerte</h4>
          <div class="space-y-1 text-sm">
            <div>🌈 Stimmung: <strong>${avgMood}/10</strong></div>
            <div>😴 Schlaf: <strong>${avgSleep}/10</strong></div>
            <div>⚡ Energie: <strong>${avgEnergy}/10</strong></div>
            ${avgSchoolStress ? `<div>📚 Schulstress: <strong>${avgSchoolStress}/10</strong></div>` : ''}
            ${avgSocialStress ? `<div>😰 Sozialer Stress: <strong>${avgSocialStress}/10</strong></div>` : ''}
          </div>
        </div>`;
      if (hasEmotions) { cardsHtml += `
        <div class="bg-green-50 p-4 rounded-lg">
          <h4 class="heading text-lg toskana-green mb-2">💟 Häufigste Emotionen</h4>
          <p class="text-sm">${topEmotions}</p>
        </div>`; }
      if (hasCoping) { cardsHtml += `
        <div class="bg-yellow-50 p-4 rounded-lg">
          <h4 class="heading text-lg toskana-green mb-2">🛠️ Bewältigungsstrategien</h4>
          <p class="text-sm">${topCoping}</p>
        </div>`; }
      if (hasBullying) { cardsHtml += `
        <div class="bg-red-50 p-4 rounded-lg">
          <h4 class="heading text-lg toskana-green mb-2">🎯 Mobbing-Statistik</h4>
          <p class="text-sm">In <strong>${bullyingPercentage}%</strong> der Einträge wurde Mobbing erlebt</p>
          <p class="text-xs text-gray-600 mt-1">${bullyingEntries.length} von ${entries.length} Einträgen</p>
        </div>`; }
      cardsHtml += `
        <div class="bg-purple-50 p-4 rounded-lg">
          <h4 class="heading text-lg toskana-green mb-2">📈 Trend</h4>
          <p class="text-sm">${entries.length >= 7 ? `Letzte 7 Tage: Ø ${(entries.slice(0, 7).reduce((sum, e) => sum + e.mood, 0) / Math.min(7, entries.length)).toFixed(1)}/10` : `${entries.length} Einträge erfasst`}</p>
        </div>`;
      analysisContainer.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${cardsHtml}</div>`;
    }

    function deleteEntry(id) {
      if (confirm('Eintrag löschen?')) {
        entries = entries.filter(e => e.id !== id);
        safeSetLocalStorage('moodEntries', entries);
        displayEntries();
        showSuccessMessage('Eintrag gelöscht!');
      }
    }

    function clearAllData() {
      if (confirm('Wirklich ALLE Einträge löschen?')) {
        entries = [];
        try { localStorage.removeItem('moodEntries'); } catch(e){}
        displayEntries();
        showSuccessMessage('Alle Einträge gelöscht!');
      }
    }

    function toggleAllEntries() {
      const checkboxes = document.querySelectorAll('.entry-checkbox');
      const allChecked = Array.from(checkboxes).every(cb => cb.checked);
      checkboxes.forEach(cb => cb.checked = !allChecked);
      updateSelectionInfo();
    }

    function getSelectedEntries() {
      const selectedIds = Array.from(document.querySelectorAll('.entry-checkbox:checked')).map(cb => parseInt(cb.dataset.entryId));
      const selected = entries.filter(entry => selectedIds.includes(entry.id));
      return selected.length ? selected : entries.slice();
    }

    function updateSelectionInfo() {
      const count = document.querySelectorAll('.entry-checkbox:checked').length;
      const infoEl = document.getElementById('selectionInfo');
      if (infoEl) infoEl.textContent = `Auswahl: ${count}`;
      const toggleBtn = document.getElementById('btnToggleAll');
      const checkboxes = document.querySelectorAll('.entry-checkbox');
      const allChecked = checkboxes.length > 0 && Array.from(checkboxes).every(cb => cb.checked);
      if (toggleBtn) toggleBtn.textContent = allChecked ? '🔄 Auswahl löschen' : '☑️ Alle auswählen';
    }

    // --- PDF / Print ---
    function buildAnalysisHTMLForPDF(allEntries) {
      if (!allEntries || allEntries.length < 3) return '';
      const avg = (arr, key) => (arr.reduce((s, e) => s + (e[key] || 0), 0) / arr.length).toFixed(1);
      const avgMood = avg(allEntries, 'mood');
      const avgSleep = avg(allEntries, 'sleep');
      const avgEnergy = avg(allEntries, 'energy');
      const school = allEntries.filter(e => (e.schoolStress || 0) > 0);
      const social = allEntries.filter(e => (e.socialStress || 0) > 0);
      const avgSchool = school.length ? (school.reduce((s, e) => s + (e.schoolStress || 0), 0) / school.length).toFixed(1) : null;
      const avgSocial = social.length ? (social.reduce((s, e) => s + (e.socialStress || 0), 0) / social.length).toFixed(1) : null;

      const emotionCounts = {};
      allEntries.forEach(e => { if (e.emotions) Object.keys(e.emotions).forEach(em => emotionCounts[em] = (emotionCounts[em] || 0) + 1); });
      const topEmotions = Object.entries(emotionCounts).sort((a,b)=>b[1]-a[1]).slice(0,3).map(([em, c]) => `${em} (${c}x)`).join(', ');

      const copingCounts = {};
      allEntries.forEach(e => (e.copingStrategies||[]).forEach(c => copingCounts[c] = (copingCounts[c] || 0) + 1));
      const topCoping = Object.entries(copingCounts).sort((a,b)=>b[1]-a[1]).slice(0,3).map(([c, n]) => `${c} (${n}x)`).join(', ');

      const bullyingEntries = allEntries.filter(e => e.bullying && e.bullying !== 'Nein' && e.bullying !== '');
      const bullyingPct = bullyingEntries.length ? ((bullyingEntries.length / allEntries.length) * 100).toFixed(1) : null;

      const last7 = allEntries.slice(0, 7);
      const trend = last7.length ? (last7.reduce((s, e) => s + (e.mood || 0), 0) / last7.length).toFixed(1) : null;

      return `
        <div style="margin-top:10px;border-top:1px solid #ccc;padding-top:12px;">
          <h2 style="font-family:'Caveat',cursive;color:#008B8B;margin:0 0 8px;">📈 Auswertung & Trends</h2>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;">
            <div style="background:#eef6ff;padding:12px;border-radius:10px;">
              <div style="font-weight:700;color:#008B8B;margin-bottom:6px;">📊 Durchschnittswerte</div>
              <div style="font-size:12px;line-height:1.6">
                <div>🌈 Stimmung: <strong>${avgMood}/10</strong></div>
                <div>😴 Schlaf: <strong>${avgSleep}/10</strong></div>
                <div>⚡ Energie: <strong>${avgEnergy}/10</strong></div>
                ${avgSchool ? `<div>📚 Schulstress: <strong>${avgSchool}/10</strong></div>` : ''}
                ${avgSocial ? `<div>😰 Sozialer Stress: <strong>${avgSocial}/10</strong></div>` : ''}
              </div>
            </div>
            ${Object.keys(emotionCounts).length ? `<div style="background:#ecfdf5;padding:12px;border-radius:10px;"><div style="font-weight:700;color:#008B8B;margin-bottom:6px;">💟 Häufigste Emotionen</div><div style="font-size:12px;">${topEmotions}</div></div>` : ''}
            ${Object.keys(copingCounts).length ? `<div style="background:#fff7ed;padding:12px;border-radius:10px;"><div style="font-weight:700;color:#008B8B;margin-bottom:6px;">🛠️ Bewältigungsstrategien</div><div style="font-size:12px;">${topCoping}</div></div>` : ''}
            ${bullyingPct ? `<div style="background:#fef2f2;padding:12px;border-radius:10px;"><div style="font-weight:700;color:#008B8B;margin-bottom:6px;">🎯 Mobbing-Statistik</div><div style="font-size:12px;">In <strong>${bullyingPct}%</strong> der Einträge wurde Mobbing erlebt</div><div style="font-size:11px;color:#666;margin-top:4px;">${bullyingEntries.length} von ${allEntries.length} Einträgen</div></div>` : ''}
            <div style="background:#f5f3ff;padding:12px;border-radius:10px;">
              <div style="font-weight:700;color:#008B8B;margin-bottom:6px;">📈 Trend</div>
              <div style="font-size:12px;">${trend ? `Letzte 7 Einträge: Ø <strong>${trend}/10</strong>` : `${allEntries.length} Einträge erfasst`}</div>
            </div>
          </div>
        </div>`;
    }

    function buildDocumentHTMLForExport(selected, title, includeAnalysis = true) {
      const analysisBlock = includeAnalysis ? buildAnalysisHTMLForPDF(entries) : '';
      let html = `<!DOCTYPE html><html lang="de"><head>
        <meta charset="UTF-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <title>${title}</title>
        <style>
          :root{color-scheme:light;}
          body{font-family: Arial, sans-serif; background:#fff; margin:16px;}
          .card{border-left:4px solid #008B8B; padding:10px 12px; margin:10px 0; background:#fff; border-radius:8px; page-break-inside: avoid; break-inside: avoid;}
          .heading{color:#008B8B}
          @page{size:A4;margin:16mm}
        </style>
      </head><body>
        <div style="text-align:center; margin-bottom:8px; font-size:22px; color:#008B8B;">${title}</div>`;
      if (analysisBlock) html += analysisBlock;
      html += `<div style="margin-top:14px; border-top:1px solid #ccc; padding-top:10px;"><h2 class="heading">📔 Ausgewählte Einträge (${selected.length})</h2>`;
      selected.forEach(entry => {
        const d = new Date(entry.dateTime).toLocaleString('de-DE', { weekday:'long', year:'numeric', month:'long', day:'numeric', hour:'2-digit', minute:'2-digit' });
        const emotions = entry.emotions ? Object.entries(entry.emotions).map(([e,v]) => `${e}: ${v}/10`).join(' • ') : '—';
        const activities = entry.activities && entry.activities.length ? entry.activities.join(', ') : '—';
        const schoolEvents = entry.schoolEvents && entry.schoolEvents.length ? entry.schoolEvents.join(', ') : '—';
        const meals = entry.meals && entry.meals.length ? entry.meals.join(', ') : '—';
        const socialEvents = entry.socialEvents && entry.socialEvents.length ? entry.socialEvents.join(', ') : '—';
        const coping = entry.copingStrategies && entry.copingStrategies.length ? entry.copingStrategies.join(', ') : '—';
        const notes = entry.notes ? entry.notes : '—';

        html += `
          <div class="card">
            <div class="heading" style="font-weight:700; margin-bottom:6px;">${d}</div>
            <div class="heading" style="font-weight:700; margin-bottom:6px;">🌈 ${entry.mood}/10 | 😴 ${entry.sleep}/10 | ⚡ ${entry.energy}/10${((entry.schoolStress||0)>0 || (entry.socialStress||0)>0) ? ` | ${ (entry.schoolStress||0)>0 ? `📚 ${entry.schoolStress}/10` : '' }${ ((entry.schoolStress||0)>0 && (entry.socialStress||0)>0) ? ' • ' : '' }${ (entry.socialStress||0)>0 ? `😰 ${entry.socialStress}/10` : '' }` : ''}</div>
            ${Object.keys(entry.emotions||{}).length ? `<div><strong>💟 Emotionen:</strong> ${emotions}</div>` : ''}
            ${entry.activities && entry.activities.length ? `<div><strong>🎯 Aktivitäten:</strong> ${activities}</div>` : ''}
            ${entry.schoolEvents && entry.schoolEvents.length ? `<div><strong>🏫 Schulerlebnisse:</strong> ${schoolEvents}</div>` : ''}
            ${entry.meals && entry.meals.length ? `<div><strong>🥗 Mahlzeiten:</strong> ${meals}</div>` : ''}
            ${entry.socialEvents && entry.socialEvents.length ? `<div><strong>👥 Soziale Ereignisse:</strong> ${socialEvents}</div>` : ''}
            ${entry.copingStrategies && entry.copingStrategies.length ? `<div><strong>🛠️ Bewältigungsstrategien:</strong> ${coping}</div>` : ''}
            ${ (entry.homework && entry.homework !== '') || (entry.bullying && entry.bullying !== 'Nein' && entry.bullying !== '') || (entry.water||0)>5 || (entry.nutrition||5)<4 || (entry.nutrition||5)>7 ? `<div><strong>📋 Besonderes:</strong> ${[
                entry.homework ? `✏️ Hausaufgaben: ${entry.homework}` : null,
                (entry.bullying && entry.bullying !== 'Nein' && entry.bullying !== '') ? `🎯 Mobbing: ${entry.bullying}` : null,
                (entry.water||0) > 5 ? `💧 Wasser: ${entry.water} Gläser` : null,
                ((entry.nutrition||5)<4 || (entry.nutrition||5)>7) ? `🍎 Ernährung: ${entry.nutrition}/10` : null
              ].filter(Boolean).join(' | ')}</div>` : ''}
            ${entry.notes && entry.notes.trim() ? `<div><strong>📝 Notizen:</strong> ${notes}</div>` : ''}
          </div>`;
      });
      html += `</div><div style="margin-top:10px; font-size:10px; color:#666; text-align:center;">© Eva Tam – Emotionstagebuch (App).</div></body></html>`;
      return html;
    }

    async function exportSelectedEntriesPDF() {
      if (!entries || entries.length === 0) { alert('❌ Es gibt noch keine Einträge.'); return; }
      const selected = getSelectedEntries();
      const username = (document.getElementById('printName').value || '').trim();
      const today = new Date().toLocaleDateString('de-DE');
      const singleMode = selected.length === 1 && document.querySelectorAll('.entry-checkbox:checked').length === 1;
      const title = singleMode ? `🧭 Emotionstagebuch — Eintrag — ${username ? username + ' — ' : ''}${today}` : `🧭 Emotionstagebuch — ${username ? username + ' — ' : ''}${today}`;

      const fullHtml = buildDocumentHTMLForExport(selected, title, !singleMode);
      const iframe = document.createElement('iframe');
      Object.assign(iframe.style, { position:'fixed', right:'0', bottom:'0', width:'0', height:'0', border:'0' });
      iframe.setAttribute('aria-hidden', 'true');
      document.body.appendChild(iframe);

      const idoc = iframe.contentDocument || iframe.contentWindow.document;
      idoc.open(); idoc.write(fullHtml); idoc.close();

      try { if (idoc.fonts && idoc.fonts.ready) await idoc.fonts.ready; } catch(e){}
      await new Promise(r => iframe.contentWindow.requestAnimationFrame(() => iframe.contentWindow.requestAnimationFrame(r)));
      const rootEl = idoc.body || idoc.documentElement;

      const opt = {
        margin: [10, 10, 14, 10],
        filename: `emotionstagebuch-${new Date().toISOString().split('T')[0]}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: Math.min(1.5, (window.devicePixelRatio || 1)), backgroundColor: '#ffffff' },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
        pagebreak: { mode: ['css', 'legacy'] }
      };
      try {
        await html2pdf().set(opt).from(rootEl).save();
        showSuccessMessage('📄 PDF erstellt!');
      } catch (err) {
        alert('❌ PDF konnte nicht erstellt werden.');
      } finally {
        setTimeout(() => { try { iframe.remove(); } catch(e){} }, 500);
      }
    }

    async function printSelectedEntries() {
      if (!entries || entries.length === 0) { alert('❌ Es gibt noch keine Einträge.'); return; }
      alert('PDF teilen? Klicke im Druckdialog auf „Als PDF speichern“. Das PDF kannst du dann per WhatsApp oder E-Mail verschicken.');
      const selected = getSelectedEntries();
      const username = (document.getElementById('printName').value || '').trim();
      const today = new Date().toLocaleDateString('de-DE');
      const singleMode = selected.length === 1 && document.querySelectorAll('.entry-checkbox:checked').length === 1;
      const title = singleMode ? `🧭 Emotionstagebuch — Eintrag — ${username ? username + ' — ' : ''}${today}` : `🧭 Emotionstagebuch — ${username ? username + ' — ' : ''}${today}`;
      const iframe = document.createElement('iframe');
      Object.assign(iframe.style, { position:'fixed', right:'0', bottom:'0', width:'0', height:'0', border:'0' });
      document.body.appendChild(iframe);
      const html = buildDocumentHTMLForExport(selected, title, !singleMode);
      const doc = iframe.contentDocument || iframe.contentWindow.document;
      doc.open(); doc.write(html); doc.close();
      try { if (doc.fonts && doc.fonts.ready) await doc.fonts.ready; } catch(e){}
      await new Promise(r => iframe.contentWindow.requestAnimationFrame(() => iframe.contentWindow.requestAnimationFrame(r)));
      iframe.contentWindow.document.title = title;
      iframe.contentWindow.focus();
      iframe.contentWindow.print();
      setTimeout(() => iframe.remove(), 1000);
    }

    function showSuccessMessage(message) {
      const successDiv = document.createElement('div');
      successDiv.className = 'success-message';
      successDiv.innerHTML = `✅ ${message}`;
      document.body.appendChild(successDiv);
      setTimeout(() => { successDiv.remove(); }, 3000);
    }
  </script>
</body>
</html>
